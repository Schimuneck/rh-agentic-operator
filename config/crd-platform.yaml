apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: agenticplatforms.agents.redhat.com
spec:
  group: agents.redhat.com
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                # Default OpenAI-compatible endpoint config (optional - agents can override)
                # This is NOT deployed by the operator, just provides defaults
                openaiDefaults:
                  type: object
                  description: "Default OpenAI-compatible endpoint config inherited by agents (external service, not deployed)"
                  properties:
                    baseUrl:
                      type: string
                      description: "Default base URL (e.g., https://api.openai.com/v1, http://llama-stack:8321)"
                    model:
                      type: string
                      default: "vllm-inference-1/qwen3-14b-awq"
                      description: "Default model for agents"
                    apiKeySecretRef:
                      type: object
                      description: "Default API key secret for agents"
                      properties:
                        name:
                          type: string
                        key:
                          type: string
                          default: "api-key"
                
                # Components to deploy in namespace
                components:
                  type: object
                  properties:
                    kagenti:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: true
                        image:
                          type: string
                          description: "Kagenti UI image (default: from operator env)"
                    mlflow:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: true
                        image:
                          type: string
                          description: "MLflow image (default: from operator env)"
                        minioImage:
                          type: string
                          description: "MinIO image (default: from operator env)"
                        postgresImage:
                          type: string
                          description: "PostgreSQL image (default: from operator env)"
                        storage:
                          type: object
                          properties:
                            size:
                              type: string
                              default: "10Gi"
                            storageClassName:
                              type: string
                        postgres:
                          type: object
                          properties:
                            storage:
                              type: string
                              default: "5Gi"
                
                # Image overrides (optional - defaults from operator environment)
                images:
                  type: object
                  description: "Override component images"
                  properties:
                    baseAgent:
                      type: string
                      description: "Base agent adapter image"
                    mlflow:
                      type: string
                    minio:
                      type: string
                    postgres:
                      type: string
                    kagentiUI:
                      type: string
                    kagentiProxy:
                      type: string
                
                # Default settings for all BaseAgents
                defaults:
                  type: object
                  properties:
                    kagenti:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: true
                    replicas:
                      type: integer
                      default: 1
                    resources:
                      type: object
                      properties:
                        requests:
                          type: object
                          x-kubernetes-preserve-unknown-fields: true
                        limits:
                          type: object
                          x-kubernetes-preserve-unknown-fields: true
                
                # ===========================================
                # Dependencies Configuration (for AgentWorkflow)
                # ===========================================
                dependencies:
                  type: object
                  description: "Configuration for required cluster operators/CRDs"
                  properties:
                    kserve:
                      type: object
                      description: "KServe dependency for model serving"
                      properties:
                        required:
                          type: boolean
                          description: "Whether KServe is required for AgentWorkflows"
                          default: true
                        installIfMissing:
                          type: boolean
                          description: "Attempt to install KServe if missing (requires cluster-admin)"
                          default: false
                    llamastackOperator:
                      type: object
                      description: "Llama Stack Operator dependency"
                      properties:
                        required:
                          type: boolean
                          description: "Whether Llama Stack Operator is required for AgentWorkflows"
                          default: true
                        installIfMissing:
                          type: boolean
                          description: "Attempt to install Llama Stack Operator if missing"
                          default: false
                    otelCollector:
                      type: object
                      description: "OpenTelemetry Collector for tracing"
                      properties:
                        enabled:
                          type: boolean
                          description: "Deploy OTEL collector per workflow namespace"
                          default: true
                    mlflowOtelBridge:
                      type: object
                      description: "OTLP to MLflow trace bridge"
                      properties:
                        enabled:
                          type: boolean
                          description: "Deploy MLflow OTEL bridge for native traces"
                          default: true
            
            status:
              type: object
              properties:
                ready:
                  type: boolean
                phase:
                  type: string
                  enum: ["Pending", "Deploying", "Ready", "Failed"]
                components:
                  type: object
                  properties:
                    kagent:
                      type: string
                    kagenti:
                      type: string
                    mlflow:
                      type: string
                mlflowConfig:
                  type: object
                  description: "Auto-generated MLflow config for agents"
                  properties:
                    trackingUri:
                      type: string
                    s3EndpointUrl:
                      type: string
                    credentialsSecretRef:
                      type: string
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
      additionalPrinterColumns:
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: MLflow
          type: string
          jsonPath: .status.components.mlflow
        - name: Kagenti
          type: string
          jsonPath: .status.components.kagenti
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      subresources:
        status: {}
  scope: Namespaced
  names:
    plural: agenticplatforms
    singular: agenticplatform
    kind: AgenticPlatform
    shortNames:
      - ap
      - platform

