apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: baseagents.agents.redhat.com
  labels:
    app.kubernetes.io/name: rh-agentic-operator
    app.kubernetes.io/managed-by: rh-agentic-operator
spec:
  group: agents.redhat.com
  names:
    kind: BaseAgent
    listKind: BaseAgentList
    plural: baseagents
    singular: baseagent
    shortNames:
      - ba
      - baseagent
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Ready
          type: string
          jsonPath: .status.ready
        - name: Endpoint
          type: string
          jsonPath: .status.endpoint
        - name: Kagenti
          type: string
          jsonPath: .status.kagentiEndpoint
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              properties:
                # ===========================================
                # Agent Instruction (System Prompt)
                # ===========================================
                instruction:
                  type: string
                  description: "System instruction/prompt that defines the agent's behavior, role, and capabilities"
                
                # ===========================================
                # OpenAI-Compatible Endpoint Configuration
                # ===========================================
                openai:
                  type: object
                  description: "OpenAI-compatible API endpoint (OpenAI, Llama Stack, vLLM, Ollama, Azure OpenAI, etc.)"
                  properties:
                    baseUrl:
                      type: string
                      description: "Base URL for OpenAI-compatible API"
                      default: "http://llama-stack-service:8321"
                    model:
                      type: string
                      description: "Model ID to use"
                      default: "vllm-inference-1/qwen3-14b-awq"
                    apiKeySecretRef:
                      type: object
                      description: "Secret containing API key (required for OpenAI/Azure, optional for local endpoints)"
                      properties:
                        name:
                          type: string
                          description: "Secret name containing the API key"
                        key:
                          type: string
                          description: "Key in the secret"
                          default: "api-key"
                
                # ===========================================
                # RAG Configuration
                # ===========================================
                rag:
                  type: object
                  description: "Retrieval-Augmented Generation configuration"
                  properties:
                    vectorStoreIds:
                      type: array
                      description: "List of vector store IDs for RAG"
                      items:
                        type: string
                    maxResults:
                      type: integer
                      description: "Maximum results per vector store search"
                      default: 10
                      minimum: 1
                      maximum: 100
                
                # ===========================================
                # MCP Tools Configuration
                # ===========================================
                mcpTools:
                  type: array
                  description: "MCP server configurations for external tools"
                  items:
                    type: object
                    required:
                      - serverUrl
                      - serverLabel
                    properties:
                      serverUrl:
                        type: string
                        description: "MCP server URL"
                      serverLabel:
                        type: string
                        description: "Display label for the MCP server"
                      secretRef:
                        type: object
                        description: "Reference to secret containing auth token"
                        properties:
                          name:
                            type: string
                            description: "Secret name"
                          key:
                            type: string
                            description: "Key in the secret"
                            default: "token"
                      allowedTools:
                        type: array
                        description: "List of allowed tool names (empty = all)"
                        items:
                          type: string
                
                # ===========================================
                # A2A Subagents Configuration
                # ===========================================
                subagents:
                  type: array
                  description: "A2A subagents to orchestrate"
                  items:
                    type: object
                    required:
                      - name
                      - url
                    properties:
                      name:
                        type: string
                        description: "Unique name for the subagent"
                      url:
                        type: string
                        description: "A2A endpoint URL of the subagent"
                      skill:
                        type: string
                        description: "Skill ID to invoke"
                        default: "answer"
                      batch:
                        type: string
                        description: "Batch group for LLM selection"
                        default: "default"
                
                # ===========================================
                # Orchestration Settings
                # ===========================================
                orchestration:
                  type: object
                  description: "A2A orchestration settings"
                  properties:
                    maxSelected:
                      type: integer
                      description: "Max subagents to call per request (0 = no limit)"
                      default: 4
                      minimum: 0
                    callTimeoutSeconds:
                      type: integer
                      description: "HTTP timeout for A2A calls"
                      default: 60
                      minimum: 5
                      maximum: 300
                    defaultBatch:
                      type: string
                      description: "Default batch name for agents without batch"
                      default: "default"
                
                # ===========================================
                # MLflow Configuration
                # ===========================================
                mlflow:
                  type: object
                  description: "MLflow tracking configuration"
                  properties:
                    trackingUri:
                      type: string
                      description: "MLflow tracking server URI"
                    experiment:
                      type: string
                      description: "MLflow experiment name"
                    s3EndpointUrl:
                      type: string
                      description: "S3 endpoint for artifact storage"
                    credentialsSecretRef:
                      type: object
                      description: "Reference to secret with AWS credentials"
                      properties:
                        name:
                          type: string
                          description: "Secret name"
                        accessKeyIdKey:
                          type: string
                          description: "Key for AWS_ACCESS_KEY_ID"
                          default: "AWS_ACCESS_KEY_ID"
                        secretAccessKeyKey:
                          type: string
                          description: "Key for AWS_SECRET_ACCESS_KEY"
                          default: "AWS_SECRET_ACCESS_KEY"
                
                # ===========================================
                # Agent Card (A2A Discovery)
                # ===========================================
                agentCard:
                  type: object
                  description: "A2A agent card metadata for discovery"
                  properties:
                    description:
                      type: string
                      description: "Human-readable description of the agent"
                    skills:
                      type: array
                      description: "Skills this agent provides"
                      items:
                        type: object
                        required:
                          - id
                          - name
                        properties:
                          id:
                            type: string
                            description: "Unique skill identifier"
                          name:
                            type: string
                            description: "Human-readable skill name"
                          description:
                            type: string
                            description: "Skill description"
                          tags:
                            type: array
                            items:
                              type: string
                
                # ===========================================
                # Kagenti Integration
                # ===========================================
                kagenti:
                  type: object
                  description: "Kagenti UI integration"
                  properties:
                    enabled:
                      type: boolean
                      description: "Enable Kagenti proxy for UI discovery"
                      default: true
                
                # ===========================================
                # Image Configuration
                # ===========================================
                image:
                  type: object
                  description: "Container image configuration"
                  properties:
                    repository:
                      type: string
                      description: "Image repository"
                    tag:
                      type: string
                      description: "Image tag"
                      default: "latest"
                    pullPolicy:
                      type: string
                      description: "Image pull policy"
                      enum: ["Always", "IfNotPresent", "Never"]
                      default: "Always"
                
                # ===========================================
                # Scaling and Resources
                # ===========================================
                replicas:
                  type: integer
                  description: "Number of adapter replicas"
                  default: 1
                  minimum: 0
                
                resources:
                  type: object
                  description: "Resource requests and limits"
                  properties:
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: "100m"
                        memory:
                          type: string
                          default: "256Mi"
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                          default: "500m"
                        memory:
                          type: string
                          default: "1Gi"
            
            # ===========================================
            # Status
            # ===========================================
            status:
              type: object
              properties:
                ready:
                  type: string
                  description: "Whether the agent is ready"
                endpoint:
                  type: string
                  description: "Internal service endpoint"
                kagentiEndpoint:
                  type: string
                  description: "Kagenti proxy endpoint"
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                        format: date-time
                observedGeneration:
                  type: integer
                  description: "Last observed generation"

